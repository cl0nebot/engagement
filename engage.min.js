var engage=function(){"use strict";var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},$$=function(){function $$(){classCallCheck(this,$$)}return createClass($$,null,[{key:"find",value:function(selector){return Array.from(document.querySelectorAll(selector))}}]),$$}(),Adapters={};Adapters.scrollCalc=function(){if(void 0===window.pageYOffset)throw new Error("Not Supported");return[window.pageXOffset,window.pageYOffset]},void 0!==document.hidden?(Adapters.vhidden="hidden",Adapters.vchange="visibilitychange"):void 0!==document.mozHidden?(Adapters.vhidden="mozHidden",Adapters.vchange="mozvisibilitychange"):void 0!==document.msHidden?(Adapters.vhidden="msHidden",Adapters.vchange="msvisibilitychange"):void 0!==document.webkitHidden&&(Adapters.vhidden="webkitHidden",Adapters.vchange="webkitvisibilitychange");var handlers=[],PubSub=function(){function PubSub(){classCallCheck(this,PubSub),this.handlers=handlers}return createClass(PubSub,[{key:"subscribe",value:function(event,handler,context){var ctx=void 0===context?handler:context;this.handlers.push({event:event,handler:handler.bind(ctx)})}},{key:"publish",value:function(event){var i=void 0;for(i=0;i<this.handlers.length;i+=1)this.handlers[i].event===event&&this.handlers[i].handler.call()}}]),PubSub}(),elements=void 0,Scroll=function(){function Scroll(element){classCallCheck(this,Scroll),this.setContentElements(element),this.update(),this.pubsub=new PubSub,this.pubsub.subscribe("Scroll",this.update,this)}return createClass(Scroll,[{key:"setContentElements",value:function(element){var _this=this;if(elements=$$.find(element),0===elements.length)throw new Error("No Elements Found");this.top=elements[0].getBoundingClientRect().top,this.bottom=elements[elements.length-1].getBoundingClientRect().bottom,elements.forEach(function(el){_this.word_count=(_this.word_count||0)+el.innerHTML.replace(/<\/?[^>]+(>|$)/g,"").split(" ").length})}},{key:"update",value:function(){var newCalc=Adapters.scrollCalc();this.xPos=newCalc[0],this.yPos=newCalc[1],this.elementInViewport=Scroll.elementsInViewport()}}],[{key:"inBounds",value:function(el){var rect=el.getBoundingClientRect();return rect.bottom>0&&rect.right>0&&rect.left<(window.innerWidth||document.documentElement.clientWidth)&&rect.top<(window.innerHeight||document.documentElement.clientHeight)}},{key:"elementsInViewport",value:function(){return elements.some(function(el){return Scroll.inBounds(el)})}}]),Scroll}(),Visibility=function(){function Visibility(){classCallCheck(this,Visibility),this.is_visible=!0,this.pubsub=new PubSub,this.pubsub.subscribe("Visibility",this.update,this)}return createClass(Visibility,[{key:"update",value:function(){this.is_visible=window.document[Adapters.vhidden]}}]),Visibility}(),Session=function(){function Session(){classCallCheck(this,Session),this.session_id=Session.sessionId(),this.referrer=Session.referrer(),this.source_url=document.URL.replace(/\/$/,"")}return createClass(Session,null,[{key:"sessionId",value:function(){var sessionId=window.sessionStorage.getItem("__engage_session");if(null==sessionId){var newId=Session.idTemplate();return window.sessionStorage.setItem("__engage_session",newId),newId}return sessionId}},{key:"referrer",value:function(){var url=document.referrer.replace(/\/$/,"");return url.match(location.hostname)?url:""}},{key:"idTemplate",value:function(){return"_"+Math.random().toString(36).substr(2,9)+"_"+Date.now()}}]),Session}(),Manager$1=function(){function Manager(options){classCallCheck(this,Manager),this.options=options,this.timestamp=(new Date).toISOString(),this.pubsub=new PubSub,this.scroll=new Scroll(options.element),this.session=new Session,this.visibility=new Visibility,this.startTracking()}return createClass(Manager,[{key:"startTracking",value:function(){var _this=this;window.addEventListener("scroll",function(){return _this.pubsub.publish("Scroll")}),document.addEventListener(Adapters.vchange,function(){return _this.pubsub.publish("Visibility")},!1)}},{key:"inspect",value:function(){return{timestamp:this.timestamp,session_id:this.session.session_id,referrer:this.session.referrer,x_pos:this.scroll.xPos,y_pos:this.scroll.yPos,top:this.scroll.top,bottom:this.scroll.bottom,word_count:this.scroll.word_count,is_visible:this.visibility.is_visible,source_url:this.session.source_url,in_viewport:this.scroll.elementInViewport}}}]),Manager}(),instance=null,defaults$$1={content:"application/vnd.engage.api+json; charset=UTF-8",url:"http://api.engage.dev/v1/metrics"},engage$2=function(){function engage(options){classCallCheck(this,engage),instance||(instance=this),this.options=_extends(defaults$$1,options),this.manager=new Manager$1(options),this.emitter()}return createClass(engage,[{key:"toJSON",value:function(){var data=_extends({api_key_id:this.options.api_key},this.options.dimensions,this.manager.inspect());return JSON.stringify({data:data})}},{key:"format",value:function(){return new window.Blob([this.toJSON()],{type:this.options.content})}},{key:"emitter",value:function(){var _this=this;setInterval(function(){window.navigator.sendBeacon(_this.options.url,_this.format())},2e3)}}],[{key:"run",value:function(options){if(!options)throw new Error("No options passed");if(!options.api_key)throw new Error("No API Key passed");if(!options.element)throw new Error("No element option passed");return new engage(options)}},{key:"instance",get:function(){if(!instance)throw new Error("Engage is not running");return instance},set:function(val){instance&&(instance=val)}}]),engage}();return window.engage=engage$2,engage$2}();
//# sourceMappingURL=engage.min.js.map