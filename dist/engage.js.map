{"version":3,"file":"engage.js","sources":["../src/utils/Utils.js","../src/utils/Adapters.js","../src/utils/PubSub.js","../src/tracking/Scroll.js","../src/tracking/Visibility.js","../src/tracking/Session.js","../src/metrics/Manager.js","../node_modules/navigator.sendbeacon/sendbeacon.js","../src/base/engage.js","../src/index.js"],"sourcesContent":["class $$ {\n\n  static find(selector) {\n    return Array.from(document.querySelectorAll(selector));\n  }\n\n}\n\nexport default $$;\n","const Adapters = {};\n\nAdapters.scrollCalc = () => {\n  if (typeof window.pageYOffset === 'undefined') throw new Error('Not Supported');\n  return [window.pageXOffset, window.pageYOffset];\n};\n\nif (typeof document.hidden !== 'undefined') { // Opera 12.10 and Firefox 18 and later support\n  Adapters.vhidden = 'hidden';\n  Adapters.vchange = 'visibilitychange';\n} else if (typeof document.mozHidden !== 'undefined') {\n  Adapters.vhidden = 'mozHidden';\n  Adapters.vchange = 'mozvisibilitychange';\n} else if (typeof document.msHidden !== 'undefined') {\n  Adapters.vhidden = 'msHidden';\n  Adapters.vchange = 'msvisibilitychange';\n} else if (typeof document.webkitHidden !== 'undefined') {\n  Adapters.vhidden = 'webkitHidden';\n  Adapters.vchange = 'webkitvisibilitychange';\n}\n\nexport default Adapters;\n","const handlers = [];\n\nclass PubSub {\n\n  constructor() {\n    this.handlers = handlers;\n  }\n\n  subscribe(event, handler, context) {\n    const ctx = (typeof context === 'undefined') ? handler : context;\n    this.handlers.push({ event, handler: handler.bind(ctx) });\n  }\n\n  publish(event) {\n    let i;\n    for (i = 0; i < this.handlers.length; i += 1) {\n      if (this.handlers[i].event === event) {\n        this.handlers[i].handler.call();\n      }\n    }\n  }\n}\n\nexport default PubSub;\n","import { $$, Adapters, PubSub } from '../utils/';\n\nlet elements;\n\nclass Scroll {\n\n  constructor(element) {\n    this.setContentElements(element);\n    this.update();\n    this.pubsub = new PubSub();\n    this.pubsub.subscribe('Scroll', this.update, this);\n  }\n\n  setContentElements(element) {\n    elements = $$.find(element);\n    if (elements.length === 0) throw new Error('No Elements Found');\n    this.top = elements[0].getBoundingClientRect().top;\n    this.bottom = elements[elements.length - 1].getBoundingClientRect().bottom;\n    elements.forEach((el) => {\n      this.word_count = (this.word_count || 0) + el.innerHTML.replace(/<\\/?[^>]+(>|$)/g, '').split(' ').length;\n    });\n  }\n\n  update() {\n    const newCalc = Adapters.scrollCalc();\n    this.xPos = newCalc[0];\n    this.yPos = newCalc[1];\n    this.elementInViewport = Scroll.elementsInViewport();\n  }\n\n  static inBounds(el) {\n    const rect = el.getBoundingClientRect();\n    return rect.bottom > 0 &&\n      rect.right > 0 &&\n      rect.left < (window.innerWidth || document.documentElement.clientWidth) &&\n      rect.top < (window.innerHeight || document.documentElement.clientHeight);\n  }\n\n  static elementsInViewport() {\n    return elements.some(el => Scroll.inBounds(el));\n  }\n}\n\nexport default Scroll;\n","import { Adapters, PubSub } from '../utils/';\n\nclass Visibility {\n\n  constructor() {\n    this.is_visible = true;\n    this.pubsub = new PubSub();\n    this.pubsub.subscribe('Visibility', this.update, this);\n  }\n\n  update() {\n    this.is_visible = window.document[Adapters.vhidden];\n  }\n\n}\n\nexport default Visibility;\n","class Session {\n\n  constructor() {\n    this.session_id = Session.sessionId();\n    this.referrer = Session.referrer();\n    this.source_url = document.URL.replace(/\\/$/, '');\n  }\n\n  static sessionId() {\n    const sessionId = window.sessionStorage.getItem('__engage_session');\n    if (sessionId == null) {\n      const newId = Session.idTemplate();\n      window.sessionStorage.setItem('__engage_session', newId);\n      return newId;\n    }\n    return sessionId;\n  }\n\n  static referrer() {\n    const url = document.referrer.replace(/\\/$/, '');\n    return url.match(location.hostname) ? url : '';\n  }\n\n  static idTemplate() {\n    return `_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`;\n  }\n\n}\n\nexport default Session;\n","import { Scroll, Session, Visibility } from '../tracking';\nimport { Adapters, PubSub } from '../utils/';\n\nclass Manager {\n\n  constructor(options) {\n    this.options = options;\n    this.timestamp = new Date().toISOString();\n    this.pubsub = new PubSub();\n    this.scroll = new Scroll(options.element);\n    this.session = new Session();\n    this.visibility = new Visibility();\n    this.startTracking();\n  }\n\n  startTracking() {\n    window.addEventListener('scroll', () => this.pubsub.publish('Scroll'));\n    document.addEventListener(Adapters.vchange, () => this.pubsub.publish('Visibility'), false);\n  }\n\n  inspect() {\n    return {\n      timestamp: this.timestamp,\n      session_id: this.session.session_id,\n      referrer: this.session.referrer,\n      x_pos: this.scroll.xPos,\n      y_pos: this.scroll.yPos,\n      top: this.scroll.top,\n      bottom: this.scroll.bottom,\n      word_count: this.scroll.word_count,\n      is_visible: this.visibility.is_visible,\n      source_url: this.session.source_url,\n      in_viewport: this.scroll.elementInViewport,\n    };\n  }\n\n}\n\nexport default Manager;\n","(function(root) {\n  'use strict';\n\n  function sendBeacon(url, data, _settings) {\n    var xhr = ('XMLHttpRequest' in window) ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');\n    xhr.open('POST', url, false);\n    xhr.withCredentials = true;\n    xhr.setRequestHeader('Accept', '*/*');\n    if (typeof data === 'string') {\n      xhr.setRequestHeader('Content-Type', 'text/plain;charset=UTF-8');\n      xhr.responseType = 'text/plain';\n    } else if (Object.prototype.toString.call(data) === '[object Blob]') {\n      if (data.type) {\n        xhr.setRequestHeader('Content-Type', data.type);\n      }\n    }\n\n    if (typeof _settings === 'object') {\n      if (!isNaN(_settings.timeout)) {\n        // xhr.timeout doesn't work for synchronous requests\n        setTimeout(function() {\n          if (xhr.readyState !== 4) {\n            xhr.abort();\n          }\n        }, _settings.timeout);\n        ;\n      }\n    }\n\n    xhr.send(data);\n    return true;\n  }\n\n  if (typeof exports !== 'undefined') {\n    if (typeof module !== 'undefined' && module.exports) {\n      exports = module.exports = sendBeacon;\n    }\n    exports.sendBeacon = sendBeacon;\n  } else if (typeof define === 'function' && define.amd) {\n    define([], function() {\n      return sendBeacon;\n    });\n  } else if ('navigator' in root && !('sendBeacon' in root.navigator)) {\n    root.navigator.sendBeacon = sendBeacon;\n  }\n})(this);\n","import Manager from '../metrics';\nimport * as Beacon from 'navigator.sendbeacon';\n\nlet instance = null;\nconst defaults = {\n  content: 'application/vnd.engage.api+json; charset=UTF-8',\n  url: 'http://api.engage.dev/v1/metrics',\n};\n\nclass engage {\n\n  constructor(options) {\n    if (!instance) { instance = this; }\n    this.options = Object.assign(defaults, options);\n    this.manager = new Manager(options);\n    this.emitter();\n  }\n\n  toJSON() {\n    const data = Object.assign(\n      { api_key_id: this.options.api_key },\n      this.options.dimensions,\n      this.manager.inspect(),\n    );\n    return JSON.stringify({ data });\n  }\n\n  format() {\n    return new window.Blob([this.toJSON()], {\n      type: this.options.content,\n    });\n  }\n\n  emitter() {\n    setInterval(() => {\n      Beacon.sendBeacon(this.options.url, this.format());\n    }, 2000);\n  }\n\n  static get instance() {\n    if (!instance) { throw new Error('Engage is not running'); }\n    return instance;\n  }\n\n  static set instance(val) {\n    if (instance) { instance = val; }\n  }\n\n  static run(options) {\n    if (!options) { throw new Error('No options passed'); }\n    if (!options.api_key) { throw new Error('No API Key passed'); }\n    if (!options.element) { throw new Error('No element option passed'); }\n    return new engage(options); // eslint-disable-line new-cap\n  }\n}\n\nexport default engage;\n","import engage from './base';\n\nwindow.engage = engage;\nexport default engage;\n"],"names":["$$","selector","Array","from","document","querySelectorAll","Adapters","scrollCalc","window","pageYOffset","Error","pageXOffset","hidden","vhidden","vchange","mozHidden","msHidden","webkitHidden","handlers","PubSub","event","handler","context","ctx","push","bind","i","length","call","elements","Scroll","element","setContentElements","update","pubsub","subscribe","find","top","getBoundingClientRect","bottom","forEach","el","word_count","innerHTML","replace","split","newCalc","xPos","yPos","elementInViewport","elementsInViewport","rect","right","left","innerWidth","documentElement","clientWidth","innerHeight","clientHeight","some","inBounds","Visibility","is_visible","Session","session_id","sessionId","referrer","source_url","URL","sessionStorage","getItem","newId","idTemplate","setItem","url","match","location","hostname","Math","random","toString","substr","Date","now","Manager","options","timestamp","toISOString","scroll","session","visibility","startTracking","addEventListener","publish","this","instance","defaults","engage","babelHelpers.extends","manager","emitter","data","api_key_id","api_key","dimensions","inspect","JSON","stringify","Blob","toJSON","content","format","val"],"mappings":"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"}