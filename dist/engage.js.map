{"version":3,"file":"engage.js","sources":["../node_modules/navigator.sendbeacon/sendbeacon.js","../src/utils/Utils.js","../src/utils/Adapters.js","../src/utils/PubSub.js","../src/tracking/Scroll.js","../src/tracking/Visibility.js","../src/tracking/Session.js","../src/metrics/Manager.js","../src/base/engage.js","../src/index.js"],"sourcesContent":["(function(root) {\n  'use strict';\n\n  function sendBeacon(url, data, _settings) {\n    var xhr = ('XMLHttpRequest' in window) ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');\n    xhr.open('POST', url, false);\n    xhr.withCredentials = true;\n    xhr.setRequestHeader('Accept', '*/*');\n    if (typeof data === 'string') {\n      xhr.setRequestHeader('Content-Type', 'text/plain;charset=UTF-8');\n      xhr.responseType = 'text/plain';\n    } else if (Object.prototype.toString.call(data) === '[object Blob]') {\n      if (data.type) {\n        xhr.setRequestHeader('Content-Type', data.type);\n      }\n    }\n\n    if (typeof _settings === 'object') {\n      if (!isNaN(_settings.timeout)) {\n        // xhr.timeout doesn't work for synchronous requests\n        setTimeout(function() {\n          if (xhr.readyState !== 4) {\n            xhr.abort();\n          }\n        }, _settings.timeout);\n        ;\n      }\n    }\n\n    xhr.send(data);\n    return true;\n  }\n\n  if (typeof exports !== 'undefined') {\n    if (typeof module !== 'undefined' && module.exports) {\n      exports = module.exports = sendBeacon;\n    }\n    exports.sendBeacon = sendBeacon;\n  } else if (typeof define === 'function' && define.amd) {\n    define([], function() {\n      return sendBeacon;\n    });\n  } else if ('navigator' in root && !('sendBeacon' in root.navigator)) {\n    root.navigator.sendBeacon = sendBeacon;\n  }\n})(this);\n","class $$ {\n\n  static find(selector) {\n    return Array.from(document.querySelectorAll(selector));\n  }\n\n}\n\nexport default $$;\n","const Adapters = {};\n\nAdapters.scrollCalc = () => {\n  if (typeof window.pageYOffset === 'undefined') throw new Error('Not Supported');\n  return [window.pageXOffset, window.pageYOffset];\n};\n\nif (typeof document.hidden !== 'undefined') { // Opera 12.10 and Firefox 18 and later support\n  Adapters.vhidden = 'hidden';\n  Adapters.vchange = 'visibilitychange';\n} else if (typeof document.mozHidden !== 'undefined') {\n  Adapters.vhidden = 'mozHidden';\n  Adapters.vchange = 'mozvisibilitychange';\n} else if (typeof document.msHidden !== 'undefined') {\n  Adapters.vhidden = 'msHidden';\n  Adapters.vchange = 'msvisibilitychange';\n} else if (typeof document.webkitHidden !== 'undefined') {\n  Adapters.vhidden = 'webkitHidden';\n  Adapters.vchange = 'webkitvisibilitychange';\n}\n\nexport default Adapters;\n","const handlers = [];\n\nclass PubSub {\n\n  constructor() {\n    this.handlers = handlers;\n  }\n\n  subscribe(event, handler, context) {\n    const ctx = (typeof context === 'undefined') ? handler : context;\n    this.handlers.push({ event, handler: handler.bind(ctx) });\n  }\n\n  publish(event) {\n    let i;\n    for (i = 0; i < this.handlers.length; i += 1) {\n      if (this.handlers[i].event === event) {\n        this.handlers[i].handler.call();\n      }\n    }\n  }\n}\n\nexport default PubSub;\n","import { $$, Adapters, PubSub } from '../utils/';\n\nlet elements;\n\nclass Scroll {\n\n  constructor(element) {\n    this.setContentElements(element);\n    this.update();\n    this.pubsub = new PubSub();\n    this.pubsub.subscribe('Scroll', this.update, this);\n  }\n\n  setContentElements(element) {\n    elements = $$.find(element);\n    if (elements.length === 0) throw new Error('No Elements Found');\n    this.top = elements[0].getBoundingClientRect().top;\n    this.bottom = elements[elements.length - 1].getBoundingClientRect().bottom;\n    elements.forEach((el) => {\n      this.word_count = (this.word_count || 0) + el.innerHTML.replace(/<\\/?[^>]+(>|$)/g, '').split(' ').length;\n    });\n  }\n\n  update() {\n    const newCalc = Adapters.scrollCalc();\n    this.xPos = newCalc[0];\n    this.yPos = newCalc[1];\n    this.elementInViewport = Scroll.elementsInViewport();\n  }\n\n  static inBounds(el) {\n    const rect = el.getBoundingClientRect();\n    return rect.bottom > 0 &&\n      rect.right > 0 &&\n      rect.left < (window.innerWidth || document.documentElement.clientWidth) &&\n      rect.top < (window.innerHeight || document.documentElement.clientHeight);\n  }\n\n  static elementsInViewport() {\n    return elements.some(el => Scroll.inBounds(el));\n  }\n}\n\nexport default Scroll;\n","import { Adapters, PubSub } from '../utils/';\n\nclass Visibility {\n\n  constructor() {\n    this.is_visible = true;\n    this.pubsub = new PubSub();\n    this.pubsub.subscribe('Visibility', this.update, this);\n  }\n\n  update() {\n    this.is_visible = window.document[Adapters.vhidden];\n  }\n\n}\n\nexport default Visibility;\n","class Session {\n\n  constructor() {\n    this.session_id = Session.sessionId();\n    this.referrer = Session.referrer();\n    this.source_url = document.URL.replace(/\\/$/, '');\n  }\n\n  static sessionId() {\n    const sessionId = window.sessionStorage.getItem('__engage_session');\n    if (sessionId == null) {\n      const newId = Session.idTemplate();\n      window.sessionStorage.setItem('__engage_session', newId);\n      return newId;\n    }\n    return sessionId;\n  }\n\n  static referrer() {\n    const url = document.referrer.replace(/\\/$/, '');\n    return url.match(location.hostname) ? url : '';\n  }\n\n  static idTemplate() {\n    return `_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`;\n  }\n\n}\n\nexport default Session;\n","import { Scroll, Session, Visibility } from '../tracking';\nimport { Adapters, PubSub } from '../utils/';\n\nclass Manager {\n\n  constructor(options) {\n    this.options = options;\n    this.timestamp = new Date().toISOString();\n    this.pubsub = new PubSub();\n    this.scroll = new Scroll(options.element);\n    this.session = new Session();\n    this.visibility = new Visibility();\n    this.startTracking();\n  }\n\n  startTracking() {\n    window.addEventListener('scroll', () => this.pubsub.publish('Scroll'));\n    document.addEventListener(Adapters.vchange, () => this.pubsub.publish('Visibility'), false);\n  }\n\n  inspect() {\n    return {\n      timestamp: this.timestamp,\n      session_id: this.session.session_id,\n      referrer: this.session.referrer,\n      x_pos: this.scroll.xPos,\n      y_pos: this.scroll.yPos,\n      top: this.scroll.top,\n      bottom: this.scroll.bottom,\n      word_count: this.scroll.word_count,\n      is_visible: this.visibility.is_visible,\n      source_url: this.session.source_url,\n      in_viewport: this.scroll.elementInViewport,\n    };\n  }\n\n}\n\nexport default Manager;\n","import * as Beacon from 'navigator.sendbeacon';\nimport Manager from '../metrics';\n\nlet instance = null;\nconst defaults = {\n  content: 'application/vnd.engage.api+json; charset=UTF-8',\n  url: 'http://api.engage.dev/v1/metrics',\n};\n\nclass engage {\n\n  constructor(options) {\n    if (!instance) { instance = this; }\n    this.options = Object.assign(defaults, options);\n    this.manager = new Manager(options);\n    this.emitter();\n  }\n\n  toJSON() {\n    const data = Object.assign(\n      { api_key_id: this.options.api_key },\n      this.options.dimensions,\n      this.manager.inspect(),\n    );\n    return JSON.stringify({ data });\n  }\n\n  format() {\n    return new window.Blob([this.toJSON()], {\n      type: this.options.content,\n    });\n  }\n\n  emitter() {\n    setInterval(() => {\n      Beacon.sendBeacon(this.options.url, this.format());\n    }, 2000);\n  }\n\n  static get instance() {\n    if (!instance) { throw new Error('Engage is not running'); }\n    return instance;\n  }\n\n  static set instance(val) {\n    if (instance) { instance = val; }\n  }\n\n  static run(options) {\n    if (!options) { throw new Error('No options passed'); }\n    if (!options.api_key) { throw new Error('No API Key passed'); }\n    if (!options.element) { throw new Error('No element option passed'); }\n    return new engage(options); // eslint-disable-line new-cap\n  }\n}\n\nexport default engage;\n","import engage from './base';\n\nwindow.engage = engage;\nexport default engage;\n"],"names":["root","sendBeacon","url","data","_settings","xhr","window","XMLHttpRequest","ActiveXObject","open","withCredentials","setRequestHeader","responseType","Object","prototype","toString","call","type","isNaN","timeout","setTimeout","readyState","abort","send","module","exports","$$","selector","Array","from","document","querySelectorAll","Adapters","scrollCalc","pageYOffset","Error","pageXOffset","hidden","vhidden","vchange","mozHidden","msHidden","webkitHidden","handlers","PubSub","event","handler","context","ctx","push","bind","i","this","length","elements","Scroll","element","setContentElements","update","pubsub","subscribe","find","top","getBoundingClientRect","bottom","forEach","el","word_count","_this","innerHTML","replace","split","newCalc","xPos","yPos","elementInViewport","elementsInViewport","rect","right","left","innerWidth","documentElement","clientWidth","innerHeight","clientHeight","some","inBounds","Visibility","is_visible","Session","session_id","sessionId","referrer","source_url","URL","sessionStorage","getItem","newId","idTemplate","setItem","match","location","hostname","Math","random","substr","Date","now","Manager","options","timestamp","toISOString","scroll","session","visibility","startTracking","addEventListener","publish","instance","defaults","engage","babelHelpers.extends","manager","emitter","api_key_id","api_key","dimensions","inspect","JSON","stringify","Blob","toJSON","content","format","val"],"mappings":"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"}